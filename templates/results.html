{% extends "base.html" %}
{% block title %}Results{% endblock %}
{% block content %}
    <div class="container">
        <h1 class="my-lg-5">Results</h1>
        <div class="row">
            {% for _ in range(2) %}
            <div class="col">
                <div class="card bg-dark">
                    <div class="card-header">
                        <h5>Kill Contribution</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-borderless table-dark">
                            <thead>
                                <th>Kill Contribution</th>
                                <th>Top 3 Kill Contribution</th>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ kill_contrib }}</td>
                                    <td>{{ kill_contrib_1 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="row">
            <div class="col">
                <div class="card bg-dark">
                    <div class="card-header">
                        <h5>Placement Frequency</h5>
                    </div>
                    <div class="card-body">
                        <svg id="placefreq-svg" width=400 height=300></svg>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card bg-dark">
                    <div class="card-header">
                        <h5>Placement Probability</h5>
                    </div>
                    <div class="card-body">
                        <svg id="placeprob-svg" width=400 height=300></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
    function placefreq() {
        const height = 300;
        const width = 400;
        const margin = ({top: 20, right: 20, bottom: 30, left: 40});

        const svg = d3.select("#placefreq-svg");

        let placements_data = {{ placements_data }};

        const x = d3.scaleLinear()
            .domain([1, 20]).nice()
            .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
            .domain([0, {{ max_placefreq }}]).nice()
            .range([height - margin.bottom, margin.top]);

        bar = svg.append("g")
            .selectAll("rect")
            .data(placements_data)
            .join("rect")
            .attr("fill", function (d, i) {
                if (i === 0)
                    return "#ffdf00";
                if (i === 1)
                    return "#ef20ff";
                if (i === 2)
                    return "#4d95ff";
                return "firebrick";
            })
            .attr("x", function (d, i) { return x(i) + 1 })
            .attr("width", function (d, i) { return Math.max(0, x(i + 1) - x(i) - 1) })
            .attr("y", function (d) { return y(d) })
            .attr("height", function (d) { return y(0) - y(d) });

        {#const kernelDensityEstimator = (kernel, X) => V => X.map(x => [x, d3.mean(V, v => kernel(x - v))]);#}
        {#const kernelEpanechnikov = k => v => Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;#}
        {#let density = kernelDensityEstimator(kernelEpanechnikov(7), x.ticks(20))(placements_data);#}
        {#svg.select("g").append("path")#}
        {#    .datum(density)#}
        {#    .attr("fill", "none")#}
        {#    .attr("stroke", "#fff")#}
        {#    .attr("stroke-width", 3)#}
        {#    .attr("stroke-linejoin", "round")#}
        {#    .attr("d", d3.line()#}
        {#        .curve(d3.curveBasis)#}
        {#        .x(d => x(d[0]))#}
        {#        .y(d => y(d[1])));#}

        function xAxis(g) {
            g.attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .call(function (g) {
                    g.append("text")
                        .attr("x", width - margin.right)
                        .attr("y", -4)
                        .attr("fill", "#fff")
                        .attr("font-weight", "bold")
                        .attr("text-anchor", "end")
                        .text("Squad Placed")
                })
        }

        function yAxis(g) {
            g.attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .call(function (g) {
                    g.select(".domain").remove()
                })
                .call(function (g) {
                    g.select(".tick:last-of-type text").clone()
                        .attr("x", 4)
                        .attr("text-anchor", "start")
                        .attr("font-weight", "bold")
                        .text("Number of Times")
                })
        }

        svg.append("g")
            .call(xAxis);

        svg.append("g")
            .call(yAxis);

    }

    function placeprob() {
        const height = 300;
        const width = 400;
        const margin = ({top: 20, right: 20, bottom: 30, left: 40});

        const svg = d3.select("#placeprob-svg");

        let placements_prob = {{ placements_prob }};

        const x = d3.scaleLinear()
            .domain([1, 20]).nice()
            .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
            .domain([0, 100]).nice()
            .range([height - margin.bottom, margin.top]);

        {#bar = svg.append("g")#}
        {#    .selectAll("rect")#}
        {#    .data(placements_prob)#}
        {#    .join("rect")#}
        {#    .attr("fill", function (d, i) {#}
        {#        if (i === 0)#}
        {#            return "#ffdf00";#}
        {#        if (i === 1)#}
        {#            return "#ef20ff";#}
        {#        if (i === 2)#}
        {#            return "#4d95ff";#}
        {#        return "firebrick";#}
        {#    })#}
        {#    .attr("x", function (d, i) { return x(i) + 1 })#}
        {#    .attr("width", function (d, i) { return Math.max(0, x(i + 1) - x(i) - 1) })#}
        {#    .attr("y", function (d) { return y(d) })#}
        {#    .attr("height", function (d) { return y(0) - y(d) });#}

        let linefunction1 = d3.line()
            .x((d, i) => x(i+1) + 1)
            .y((d, i) => y(d))
            .curve(d3.curveStepAfter);

        let linefunction2 = d3.line()
            .x((d, i) => x(i+2) + 1)
            .y((d, i) => y(d))
            .curve(d3.curveStepAfter);

        let linefunction3 = d3.line()
            .x((d, i) => x(i+3) + 1)
            .y((d, i) => y(d))
            .curve(d3.curveStepAfter);

        let linefunction = d3.line()
            .x((d, i) => x(i+4) + 1)
            .y((d, i) => y(d))
            .curve(d3.curveStepAfter);

        let g = svg.append("g");

        g.append("path")
            .attr("d", linefunction1(placements_prob.slice(0, 2)))
            .attr("stroke", "#ffdf00")
            .attr("stroke-width", "2")
            .attr("fill", "none");

        g.append("path")
            .attr("d", linefunction2(placements_prob.slice(1, 3)))
            .attr("stroke", "#ef20ff")
            .attr("stroke-width", "2")
            .attr("fill", "none");

        g.append("path")
            .attr("d", linefunction3(placements_prob.slice(2, 4)))
            .attr("stroke", "#4d95ff")
            .attr("stroke-width", "2")
            .attr("fill", "none");

        g.append("path")
            .attr("d", linefunction(placements_prob.slice(3)))
            .attr("stroke", "firebrick")
            .attr("stroke-width", "2")
            .attr("fill", "none");

        function xAxis(g) {
            g.attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .call(function (g) {
                    g.append("text")
                        .attr("x", width - margin.right)
                        .attr("y", -4)
                        .attr("fill", "#fff")
                        .attr("font-weight", "bold")
                        .attr("text-anchor", "end")
                        .text("Squad Placed At Least")
                })
        }

        function yAxis(g) {
            g.attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .call(function (g) {
                    g.select(".domain").remove()
                })
                .call(function (g) {
                    g.select(".tick:last-of-type text").clone()
                        .attr("x", 4)
                        .attr("text-anchor", "start")
                        .attr("font-weight", "bold")
                        .text("% of the Time")
                })
        }

        svg.append("g")
            .call(xAxis);

        svg.append("g")
            .call(yAxis);

    }

    placefreq();
    placeprob();
    </script>
{% endblock %}
