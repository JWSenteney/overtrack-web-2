{% import 'games/game_summary.html' as game_summary with context %}

{% extends "base.html" %}
{% block title %}Games{% endblock %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/games.css') }}">
{% endblock %}
{% block content %}
<br/>
    <section>
        <div class="container">
            <div class="row">
                <div class="col-sm-4 games-list-panels">
                    <div class="card bg-dark season-selector">
                        <div class="card-body">
                            <!-- <h5>Season:</h5> -->
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Season {{ season.index }}{{ " Ranked" if is_ranked else "" }}
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    {% for s in seasons %}
                                        {% if s >= 2 %}
                                            <a class="dropdown-item" href="?season={{ s }}&ranked=true">Season {{ s }} Ranked</a>
                                        {% endif %}
                                        <a class="dropdown-item" href="?season={{ s }}&ranked=false">Season {{ s }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5>Most recent match</h5>
                        </div>
                        <div class="card-body">
                            Coming Soon!
                        </div>
                    </div>
                    {% if is_ranked %}
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5>Rank</h5>
                        </div>
                        <div class="card-body">
                            Coming Soon!
                        </div>
                    </div>
                    {% endif %}
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5>Stats</h5>
                        </div>
                        <div class="card-body">
                            Coming Soon!
                        </div>
                    </div>
                </div>

                <div class="col-sm-8">
                    <div class="table-responsive">
                        <table class="table table-borderless table-striped table-hover table-dark shadow games-list narrow">
                            <thead class="">
                                {{ game_summary.header() }}
                            </thead>
                            <tbody>
                            {% for game in games %}
                                <tr><td class="date-divider" colspan="{{10}}" data-timestamp="{{game.timestamp}}"></td></div>
                                <tr></tr>
                                {{ game_summary.summary(game) }}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}


{% block scripts %}
<script type="text/javascript">
    let times = document.getElementsByClassName('datetime-format-time');
    for (let e of times){
        let t = new Date(e.innerText * 1000);
        e.innerText = t.toLocaleString('default', {
            hour: 'numeric',
            minute: '2-digit'
        });
    }

    let dates = document.getElementsByClassName('date-divider');
    let dateOpts = {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        // year: 'numeric',
    };
    let lastText = new Date().toLocaleString('default', dateOpts);
    for (let e of dates){
        let d = new Date(+e.getAttribute('data-timestamp') * 1000);
        let text = d.toLocaleString('default', dateOpts);
        if (text != lastText){
            lastText = text;
            e.innerText = text;
            e.classList.add('date-divider-visible');
        }
    }

    let style = document.createElement('style');
    let head = document.head || document.getElementsByTagName('head')[0];
    head.appendChild(style);
    style.type = 'text/css';
    let css = `
.datetime-format-time {
    display: table-cell !important;
}
.date-divider-visible {
    display: table-cell !important;
}
`;
    if (style.styleSheet){
        style.styleSheet.cssText = css;
    } else {
        style.appendChild(document.createTextNode(css));
    }
    document.head.appendChild(style);

    $(document).ready(function($) {
        $("tr.clickable").click(function() {
            window.document.location = $(this).data("href");
        });
        $("tr.clickable").mouseup(function() {
            if (event.button === 1){
                window.open($(this).data("href"));
            }
        });
    });
</script>
{% endblock %}
